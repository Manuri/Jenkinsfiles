#!groovy
node {
    def tagMap = [:];
    String user = "manuri";
    String gitCredentialsID = "manuri-pipeline-git";
    try {
        env.PATH = "${tool 'apache-maven-3.2.2'}/bin:${env.PATH}"
        env.JAVA_HOME="${tool 'Oracle-JDK-1.8.0_45'}"
        env.PATH="${env.JAVA_HOME}/bin:${env.PATH}"

        String settingsXMLID = "adb07180-fa9c-4bea-94c4-130813b8018c-manuri";
        String ballerinaRepository = "ballerina-temp";
        String docerinaRepository = "docerina-temp";
        String testerinaRepository = "testerina-temp";
        String connectorsRepository = "connectors-temp";
        String containerSupportRepository = "container-support-temp";
        String toolsDistributionRepository = "tools-distribution-temp";
        String toolSwaggerBallerinaRepository = "tool-swagger-ballerina-temp";
        String ballerinaGroudId = "org.ballerinalang";

       /* stage('Building ballerina') {
            cloneRepository(ballerinaRepository, user, gitCredentialsID);
            String ballerinaTag = getLatestGitTag(ballerinaRepository);
            release(settingsXMLID, ballerinaRepository);
            tagMap.put(ballerinaRepository, ballerinaTag);
            //releaseWithFailureRecovery(settingsXMLID, ballerinaRepository, user);
        }*/

        stage('Building docerina, testerina, connectors, container-support') {
            parallel docerinaRelease: {
                cloneRepository(docerinaRepository, user, gitCredentialsID);

                updateProperties(docerinaRepository, gitCredentialsID, settingsXMLID, user, "Updating properties",
                        "${ballerinaGroudId}:*");

                String docerinaTag = getLatestGitTag(docerinaRepository);

                release(settingsXMLID, docerinaRepository)

                tagMap.put(docerinaRepository, docerinaTag);

                //releaseWithFailureRecovery(settingsXMLID, docerinaRepository, user);
            }, testerinaRelease: {
                cloneRepository(testerinaRepository, user, gitCredentialsID);

                updateProperties(testerinaRepository, gitCredentialsID, settingsXMLID, user, "Updating properties",
                        "${ballerinaGroudId}:*");

                String testerinaTag = getLatestGitTag(testerinaRepository);

                release(settingsXMLID, testerinaRepository)

                tagMap.put(testerinaRepository,testerinaTag );
                //releaseWithFailureRecovery(settingsXMLID, testerinaRepository, user);
            }, connectorsRelease: {
                cloneRepository(connectorsRepository, user, gitCredentialsID);

                updateProperties(connectorsRepository, gitCredentialsID, settingsXMLID, user, "Updating properties",
                        "${ballerinaGroudId}:*");

                String connectorsTag = getLatestGitTag(connectorsRepository);
                release(settingsXMLID, connectorsRepository)

                tagMap.put(connectorsRepository, connectorsTag);
                //releaseWithFailureRecovery(settingsXMLID, connectorsRepository, user);
            }, containerSupportRelease: {
                cloneRepository(containerSupportRepository, user, gitCredentialsID);

                updateProperties(containerSupportRepository, gitCredentialsID, settingsXMLID, user, "Updating properties",
                        "${ballerinaGroudId}:*");

                String containerSupportTag = getLatestGitTag(containerSupportRepository);

                release(settingsXMLID, containerSupportRepository, containerSupportTag)

                tagMap.put(containerSupportRepository, containerSupportTag);
                //releaseWithFailureRecovery(settingsXMLID, containerSupportRepository, user);
            }, toolSwaggerBallerinaRelease: {
                cloneRepository(toolSwaggerBallerinaRepository, user, gitCredentialsID);

                updateProperties(toolSwaggerBallerinaRepository, gitCredentialsID, settingsXMLID, user, "Updating properties",
                        "${ballerinaGroudId}:*");

                String toolSwaggerTag = getLatestGitTag(toolSwaggerBallerinaRepository);

                release(settingsXMLID, toolSwaggerBallerinaRepository);

                tagMap.put(toolSwaggerBallerinaRepository, toolSwaggerTag);
                //releaseWithFailureRecovery(settingsXMLID, toolSwaggerBallerinaRepository, user);
            }, failFast: true
        }

        stage('Building tools-distribution') {
            cloneRepository(toolsDistributionRepository, user, gitCredentialsID);

            updateProperties(toolsDistributionRepository, gitCredentialsID, settingsXMLID, user, "Updating properties",
                    "${ballerinaGroudId}:*");

            String toolsDstributionTag = getLatestGitTag(toolsDistributionRepository);

            release(settingsXMLID, toolsDistributionRepository);

            tagMap.put(toolsDistributionRepository, toolsDstributionTag);
            //releaseWithFailureRecovery(settingsXMLID, toolsDistributionRepository, user);
        }
    } catch (Exception e){
        sh "echo 'An exception has occurred in one of the builds'";
        /*tagMap.each { repository, latestTagBeforeRelease ->
            cleanupRepositoryAfterFailure(repository.toString(), user, latestTagBeforeRelease.toString());
        }*/
       // iterateTagMap(tagMap, user)
        for (it2 in mapToList(tagMap)) {
            cleanupRepositoryAfterFailure(it2[0].toString(), user, it2[1].toString(), gitCredentialsID)
        }

    } finally {
        stage('Clean Up') {
            try {
                deleteDir();
            } catch (Exception e) {
                sh("echo 'Unable to delete directory. Please manually delete'");
                //println("Unable to delete directory. Please manually delete")
            }
        }
    }
}

def cloneRepository(String repositoryName, String user, String credentials) {
    checkout([
            $class: 'GitSCM',
            branches: [[name: '*/master']],
            doGenerateSubmoduleConfigurations: false,
            extensions: [[$class: 'LocalBranch', localBranch: 'release'],
                         [$class: 'RelativeTargetDirectory', relativeTargetDir: repositoryName]],
            submoduleCfg: [],
            userRemoteConfigs:
                    [[credentialsId: credentials,
                      url: "http://github.com/${user}/${repositoryName}.git"]]])
}

def updateProperties(String repositoryName, String credentials, String settingsXml, String user, String commitMessage, String propertiesList) {
    configFileProvider(
            [configFile(fileId: settingsXml, variable: 'MAVEN_SETTINGS')]) {
        dir(repositoryName) {
            sh "mvn -s $MAVEN_SETTINGS versions:update-properties -Dincludes=${propertiesList}"
            boolean changesPresent = sh (
                    script: "git diff-index --quiet HEAD",
                    returnStatus: true
            ) == 1
            if (changesPresent) {
                sh("git add -u")
                sh("git commit -m '${commitMessage}'");
            }
        }
    }
}

def release(String settingsXml, String repositoryDir) {
    configFileProvider(
            [configFile(fileId: settingsXml, variable: 'MAVEN_SETTINGS')]) {
        dir(repositoryDir) { sh 'mvn -s $MAVEN_SETTINGS release:prepare release:perform -B -Darguments="-Dmaven.deploy.skip=true -DskipTests=true"' }
    }
}

def cleanupRepositoryAfterFailure(String repositoryName, String user, String latestTagBeforeRelease, String credentials) {
    sh "echo 'Failure has occurred in ${repositoryName} build.'";
    sh "echo 'Latest tag before release ${latestTagBeforeRelease}'";
    String latestTagAfterRelease = getLatestGitTag(repositoryName);
    sh "echo 'Latest tag after release ${latestTagAfterRelease}'";
    dir(repositoryName) {
        withCredentials(
                [[$class          : 'UsernamePasswordMultiBinding',
                  credentialsId   : credentials,
                  usernameVariable: 'GIT_USERNAME',
                  passwordVariable: 'GIT_PASSWORD']]) {
            sh("git remote set-url origin https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/${user}/${repositoryName}.git")
            if (latestTagAfterRelease != null && !latestTagAfterRelease.equals(latestTagBeforeRelease)) {
                sh "echo 'Deleting tag ${latestTagAfterRelease} in ${repositoryName}'";
                sh(
                        script: "git push --delete origin ${latestTagAfterRelease}",
                        returnStatus: true
                );
            }
            sh "echo 'Deleting release branch of ${repositoryName}'";
            sh(
                    script: "git push --delete origin release",
                    returnStatus: true
            );
        }
    }
}

def String getLatestGitTag (String repositoryDir) {
    sh "echo 'Inside getLatestGitTag: ${repositoryDir}'";
    dir(repositoryDir) {
       /* String availableTags = sh (
                script: "git tag",
                returnStdout: true
        );*/

        sh 'git tag > tags'
        def availableTags = readFile('tags');

        if (!"".equals(availableTags.trim())) {
            /*String latestTag = sh(
                    script: "git describe --abbrev=0",
                    returnStdout: true
            );*/
            sh 'git describe --abbrev=0 > latesttag'
            def latestTag = readFile('latesttag').trim();
            sh "echo 'Latest tag: ${latestTag}'";
            return latestTag.trim();
        } else {
            sh "echo 'No tags available'";
            return null;
        }
    }
}

/*@NonCPS
def iterateTagMap(tagMap, String user) {
    for (Map.Entry<String, String> entry : tagMap) {
        cleanupRepositoryAfterFailure(entry.key, user, entry.value)
    }
}*/

@NonCPS
def mapToList(depmap) {
    def dlist = []
    for (entry in depmap) {
        dlist.add([entry.key, entry.value])
    }
    dlist
}









